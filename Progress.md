# Progress

## 概要
- FIELD / VILLAGE / CAVE の 24x18 マップとワープ構造、プレイヤー中心カメラ、Food 消費による探索ループを実装。
- ショップとインベントリは Phase1 仕様（Buy/Sell、装備トグル、Potion 使用、Gold/Food 管理）を満たす。
- Phase2 では FIELD に敵シンボルを常駐させ、接触でターン制戦闘（A/D/R、勝敗、報酬、レベルアップ）を導入済み。
- 今回の改修で占有テーブルと予約タイル管理を整備し、商人や入口と重ならないようにしつつイベント優先度（敵戦闘→ワープ→その他）を統一。
- ストーリー進行（Ancient Key、遺跡クリア）や宝箱イベントなどは未着手で、将来的な拡張が必要。

## 比較リスト
| 項目 | 期待仕様 (GAME_DESIGN.md) | 現状実装 | コメント |
| --- | --- | --- | --- |
| シーン構成 | FIELD / VILLAGE / CAVE を 24x18 タイルで表現し、入口タイルで遷移 | `map_data.js` に 3 シーンとスポーン/ワープ設定を実装。遷移時にプレイヤー位置を調整 | 洞窟宝箱や遺跡クリアなどシナリオイベントは未実装 |
| タイル / 描画 | タイル 32px・800x360 表示・ランドマーク用アイコン | タイル 40px＋プレイヤー中心カメラで描画。主要タイルに絵文字アイコン表示 | タイルサイズが設計値と異なるが、レイアウトは維持 |
| 占有 / 衝突 | タイルごとに通行判定、入口でイベント発火 | `game_state.js` に占有テーブルと予約タイルを導入し、NPC/敵/入口の重なりを排除。`resolveTileEvent` でイベント優先度を統一 | 宝箱など「その他イベント」は未実装のため空欄 |
| プレイヤー操作 | 矢印キー移動、通行不可ブロック、入口接触で遷移 | `input.js` が `isFreeForPlayer` と `resolveTileEvent` を使用。商人タイル侵入禁止、敵タイルでは戦闘優先 | 鍵チェックや特殊タイルイベントは未搭載 |
| リソース / 空腹 | HP/ATK/DEF/LV/EXP、Food=2歩で1消費、Food0でHP減少 | 初期パラメータと Food 消費処理を実装。Food 補充はショップ購入で対応 | LV/EXP閾値とレベルアップ効果は実装済みだが、ストーリー報酬は未設定 |
| メッセージ / UI | 上段マップ＋中段メッセージ/ステータス＋下段コマンド | 3 パネル＋メッセージ 3 件表示に加え、ショップ／インベントリ／ステータス／戦闘の各オーバーレイを表示 | ログ履歴や詳細ステータス表示の拡張余地あり |
| 操作キー | T:会話、I/U/S:メニュー、A/D/R:戦闘、Enter/Esc:操作 | 戦闘キー A/D/R が有効。T は NPC 隣接時のみ機能。I/U/S/Esc で各オーバーレイを制御 | Enter はメッセージ送り専用ではなく、今後改善の余地あり |
| 商人 / ショップ | Buy/Sell、価格提示、在庫チェック、会話から開く | 商人は固定配置でプレイヤーと重ならない。`shop.js` で Buy/B=即購入・Sell/S+Enter を実装。Gold/枠/装備チェック済み | 会話テキストや在庫変動、価格調整は未実装 |
| インベントリ / アイテム | 6枠、Potion/Weapon/Shield/Key、装備で ATK/DEF 上昇 | インベントリ管理・装備トグル・Potion 使用を実装。Ancient Key は未使用 | カテゴリ整理、並び替え、敵ドロップなどは未対応 |
| 経済 | Food/Potion/装備の買値、売値=50%、Food は数値リソース | PRICE テーブルと売値 50% を実装。Food×10 は数値に直接加算 | 新アイテムや在庫制限など経済バランス調整は未着手 |
| 敵シンボル / 戦闘 | フィールドに敵シンボルを配置し、接触でターン制戦闘 (A/D/R) | FIELD に 3〜5 体スポーン（入口周辺は禁止）。戦闘は攻撃/防御/逃走、勝利報酬、微回復、LV 判定、敗北時の安全復帰を実装 | 敵の特殊行動、ドロップ、シーン別微調整は未実装 |
| 進行イベント | 洞窟宝箱で鍵入手→遺跡でクリア、演出 | `state.flags.hasKey` などフラグのみ存在し、取得/使用ロジックは未実装 | 鍵入手イベント、遺跡判定、クリア演出は今後の開発範囲 |
