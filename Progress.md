# Progress

## 概要
- FIELD / VILLAGE / CAVE の3シーンとワープ構造、プレイヤー中心カメラ、空腹（Food）管理まで探索の基本ループを完全実装済み。
- ショップとインベントリが仕様に沿って動作し、Buy/Sell・装備トグル・ポーション使用などが可能。
- 描画システムは完成（タイル、絵文字、UI、オーバーレイ）し、リソース管理も動作している。
- **未実装：** 戦闘システム、敵配置、レベルアップ、鍵イベント、遺跡クリア判定。

## 実装状況詳細

### ✅ 完全実装済み

#### 1. シーン・マップシステム (map_data.js)
- **FIELD/VILLAGE/CAVE** 3シーンの24x18タイルマップ
- 各シーンの入口タイル（🏘️、🕳️、🚪）とワープ機能
- スポーン地点の管理（default、fromVillage、fromCave、fromField）
- シーン遷移時のプレイヤー位置復帰

#### 2. 描画システム (renderer.js, entities.js)
- **プレイヤー中心カメラ**：常にプレイヤーが画面中央
- **タイル描画**：色タイルと絵文字オーバーレイ
  - 地形色：Grass/Road/Water/Floor/Cave
  - ランドマーク絵文字：⛰️🪨🌲🏘️🕳️🏛️🧱🚪
- **UI 3パネル**：メッセージ（最新3件）、ステータス（HP/Food/Gold/ATK/DEF/装備）、コマンド説明
- **オーバーレイ**：ショップ、インベントリ、ステータス詳細画面

#### 3. プレイヤー移動・操作 (input.js)
- **矢印キー**：4方向移動
- **通行判定**：水、山、岩、壁、遺跡は通行不可
- **入口判定**：入口タイル接触でシーン遷移
- **キーバインド**：
  - T: Talk（商人と会話）
  - I: Items（インベントリ表示）
  - U: Use（アイテム使用）
  - S: Stats（ステータス表示）
  - Enter/Esc: 決定/キャンセル
  - 矢印キー: リスト選択

#### 4. リソース管理 (game_state.js)
- **プレイヤーパラメータ**：HP(30), MaxHP(30), ATK(5), DEF(3), LV(1), EXP(0), Food(50), Gold(50)
- **Food消費**：FIELD/CAVEで2歩ごとに1消費、VILLAGE/メニュー/戦闘中は消費なし
- **飢餓状態**：Food=0で行動ごとにHP-1
- **装備システム**：weapon(ATK+2)、shield(DEF+2)
- **装備効果計算**：`getPlayerEffectiveStats()` で実効ATK/DEF算出
- **インベントリ**：最大6枠、装備は枠外

#### 5. 商人・ショップ (shop.js, game_state.js)
- **隣接判定**：商人に隣接してTキーで開店
- **Buy/Sell切替**：BキーとSキー
- **商品一覧**：Food×10(10G)、Potion(15G)、Bronze Sword(40G)、Wood Shield(35G)
- **購入処理**：
  - Gold不足チェック
  - インベントリ枠チェック（Food除く）
  - Food×10は数値加算（枠不使用）
- **売却処理**：
  - 装備中アイテムは売却不可
  - 売値=買値×50%
  - 売却後カーソル位置調整

#### 6. アイテム・装備 (game_state.js)
- **アイテム種類**：FOOD10、POTION、BRONZE_SWORD、WOOD_SHIELD、ANCIENT_KEY（定義のみ）
- **Potion使用**：HP+20回復（最大値まで）、使用後消費
- **装備トグル**：武器/盾を装備/解除（Uキーでトグル）
- **装備ボーナス**：weapon=ATK+2、shield=DEF+2
- **装備中表示**：インベントリとショップに「(装備中)」表示

#### 7. メッセージシステム (game_state.js)
- **最新3件表示**：メッセージパネルに表示
- **自動スクロール**：4件目以降は古いものから削除
- **各種通知**：移動不可、Food尽き、HP減少、購入/売却/使用結果など

### ⬜ 未実装

#### 8. 戦闘システム (combat.js)
- **現状**：`startBattle()` のスタブのみ
- **必要実装**：
  - ターン制バトルUI
  - A/D/R コマンド（Attack/Defend/Run）
  - ダメージ計算：`max(1, ATK + rnd(0..2) - ENEMY.DEF)`
  - Defend：被ダメ半減
  - Run：50%確率で離脱
  - 勝利報酬：EXP、Gold、微回復(+3HP)、低確率でFood/Potion
  - 敗北処理：HP=0でゲームオーバー

#### 9. 敵システム
- **現状**：完全未実装
- **必要実装**：
  - 敵データ定義（SLIME🫠、BAT🦇、SPIDER🕷、GHOST👻、VAMPIRE🧛‍♂️、TROLL🧌、DRAGON🐉）
  - 敵配置とリポップロジック（FIELD常時3-5体）
  - シンボル接触で戦闘開始
  - 撃破→歩数カウントでリポップ

#### 10. レベルアップ・成長 (game_state.js)
- **現状**：LV/EXPパラメータは存在するが機能せず
- **必要実装**：
  - EXP獲得処理（戦闘勝利時）
  - レベルアップ判定（しきい値：10, 30, 60, 100...）
  - ステータス上昇（HP+5, ATK+1, DEF+1）
  - レベルアップメッセージ

#### 11. 鍵イベント (input.js, game_state.js)
- **現状**：`state.flags.hasKey` フラグのみ存在
- **必要実装**：
  - 洞窟の宝箱（📦）タイル配置
  - 宝箱接触でANCIENT_KEY入手（1回限り）
  - 鍵入手メッセージ

#### 12. 遺跡クリア判定 (input.js)
- **現状**：遺跡タイル（🏛️）は通行不可で「鍵が必要」メッセージのみ
- **必要実装**：
  - 鍵所持チェック
  - 鍵所持で🏛️接触時にクリア演出
  - ゲーム終了処理

## 比較リスト（GAME_DESIGN.md vs 実装）

| 項目 | 期待仕様 (GAME_DESIGN.md) | 現状実装 | 実装率 | コメント |
| --- | --- | --- | --- | --- |
| **シーン構成** | FIELD/VILLAGE/CAVEの3シーン、24x18タイル、入口ワープ | ✅ 完全実装 | 100% | 3シーン全て動作、スポーン地点と往復ワープ完備 |
| **タイル・描画** | タイル32px、800x360表示、色＋絵文字ランドマーク | ✅ 実装済み（40px） | 95% | タイルサイズが40px（設計32px）、他は完全一致 |
| **プレイヤー移動** | 矢印キー、通行判定、入口イベント | ✅ 完全実装 | 100% | 移動、通行判定、シーン遷移すべて動作 |
| **リソース管理** | HP/ATK/DEF/LV/EXP、Food2歩=1、Food=0でHP減 | ✅ 実装済み | 80% | Food消費・HP減少は完璧。LV/EXP成長が未実装 |
| **UI・メッセージ** | 3パネル（メッセージ/ステータス/コマンド）、オーバーレイ | ✅ 完全実装 | 100% | 全パネル表示、ショップ/インベントリ/ステータスUI完備 |
| **操作キー** | T/I/U/S/A/D/R/Enter/Esc | ✅ 一部実装 | 70% | T/I/U/S/Enter/Escは完璧。A/D/Rは未実装 |
| **商人・ショップ** | Buy/Sell、価格・Gold・枠チェック、売値50% | ✅ 完全実装 | 100% | 全機能動作、装備中売却不可も実装 |
| **インベントリ** | 6枠、Potion/装備/鍵、装備でATK/DEF上昇 | ✅ 実装済み | 95% | Potion/装備は完璧。鍵は未使用 |
| **経済・価格** | Food/Potion/装備の価格、売値50%、Food数値加算 | ✅ 完全実装 | 100% | PRICEテーブル、売値計算、Food加算すべて動作 |
| **戦闘システム** | ターン制、A/D/R、ダメージ計算、勝敗処理 | ⬜ スタブのみ | 0% | `combat.js`はスタブのみ、全機能未実装 |
| **敵キャラ** | 7種の敵、HP/ATK/DEF、シンボル接触、リポップ | ⬜ 未実装 | 0% | 敵データ・配置・リポップすべて未実装 |
| **レベル成長** | EXP獲得、しきい値到達でHP/ATK/DEF上昇 | ⬜ 未実装 | 0% | LV/EXPパラメータのみ存在、成長ロジックなし |
| **鍵イベント** | 洞窟宝箱で鍵入手（1回限り） | ⬜ 未実装 | 10% | フラグのみ存在、取得ロジックなし |
| **遺跡クリア** | 鍵所持で🏛️接触→クリア | ⬜ 未実装 | 20% | 鍵チェックなし、通行不可のみ |

## 次のステップ（優先順位順）

1. **敵キャラ配置**：FIELDとCAVEに敵シンボルを配置、接触で戦闘開始
2. **戦闘システム**：ターン制UI、A/D/Rコマンド、ダメージ計算、勝敗処理
3. **レベルアップ**：EXP獲得、成長判定、ステータス上昇
4. **鍵イベント**：洞窟宝箱で鍵入手
5. **遺跡クリア**：鍵所持で🏛️接触→クリア演出

## 技術メモ

### ファイル構成
- `sketch.js` - p5.jsエントリポイント、setup/draw/keyPressed
- `game_state.js` - ゲーム状態、プレイヤー、アイテム、ショップロジック
- `map_data.js` - 3シーンのマップデータ、入口、スポーン地点
- `renderer.js` - 描画全般（マップ、UI、オーバーレイ）
- `entities.js` - 絵文字描画ユーティリティ
- `input.js` - キー入力処理、移動、オーバーレイ操作
- `shop.js` - ショップUI、Buy/Sell処理
- `combat.js` - 戦闘システム（スタブのみ）
- `utils.js` - 共通ユーティリティ（clamp、posEq、isBlocked、isAdjacent）

### 実装の特徴
- **モジュール化**：各機能をIIFEで独立実装、`Game`名前空間に登録
- **データ駆動**：TILE/ITEM/PRICE/ITEM_METAなど定数テーブルで管理
- **状態管理**：`Game.state`で単一ソース、`uiState`でUI状態分離
- **カメラシステム**：プレイヤー座標からカメラ座標算出、全描画に適用
- **メッセージキュー**：最新3件のみ保持、自動スクロール
