# Ultima-like RPG

## ゲーム概要

小さな島に漂着した冒険者（🧝）となって、生存を図りながら島の謎を解く探索型RPGです。
フィールドを探索し、敵と戦い、商人から物資を補給しながら、最終的に洞窟で **Ancient Key** を入手し、遺跡の門を開いて中枢に到達することが目標です。

### 世界

ゲームは3つのシーンで構成されています：

- **FIELD（フィールド）** - 島全体。探索、戦闘、各施設への入口がある
- **VILLAGE（村）** - 安全地帯。商人🧙‍♂️がいて、物資の売買ができる。宿屋🛏️で休息も可能
- **CAVE（洞窟）** - ミニ区画。宝箱に重要なアイテムがある。強力な敵が出現

### リソース管理

生存のために以下のリソースを管理する必要があります：

- **HP（体力）** - 0になると安全地帯に戻され、HPが全回復する
- **Food（食料）** - フィールドや洞窟で2歩ごとに1消費（村では消費しない）。0になると歩くたびにHPが減少。**上限999**
- **Gold（所持金）** - 商人から物資を購入するために必要
- **装備** - 武器スロット1つと盾スロット1つ。装備中のアイテムは売却不可
  - **Bronze Sword**（ATK+2） - 武器スロット
  - **Wood Shield**（DEF+2） - 盾スロット
- **インベントリ** - 最大6個までアイテムを所持可能（Food10は累積型で容量外）

## 操作方法

### 基本移動
- **矢印キー（↑↓←→）** - 4方向に移動

### フィールドでの操作
- **T** - Talk（会話） - 商人に隣接して話しかける
- **I** - Items（アイテム） - インベントリを開く
- **S** - Stats（ステータス） - ステータス画面を表示

### インベントリでの操作
- **↑↓** - アイテム選択
- **U** - Use（使用） - 選択中のアイテムを使用（ポーション使用や装備の装着/解除）
- **Enter** - アイテムの詳細を表示
- **Esc** - インベントリを閉じる

### ショップでの操作
- **B** - Buy（購入） - 選択中のアイテムを購入
- **S** - Sell（売却） - 選択中のアイテムを売却（装備中は売却不可、売却価格は購入価格の半額）
- **↑↓** - アイテム選択
- **Esc** - ショップを閉じる

### 宿屋での操作
- **Y** - Yes（はい） - 10Goldで宿泊し、HPを全回復
- **N** - No（いいえ） - 宿泊をキャンセル
- **条件**: HP < MaxHP かつ Gold ≥ 10の場合のみ宿泊可能

### 戦闘コマンド
- **A** - Attack（攻撃） - 敵にダメージを与える
- **D** - Defend（防御） - 受けるダメージを半減
- **R** - Run（逃げる） - 50%の確率で戦闘から離脱

### 共通操作
- **Enter** - 決定
- **Esc** - キャンセル/メニューを閉じる

## 敵の種類と出現エリア

ゲームには7種類の敵が登場します：

### フィールドの敵
- **🫠 SLIME（スライム）** - 最も弱い敵。草原に出現
- **🦇 BAT（コウモリ）** - 木の近くに出現
- **🕷 SPIDER（蜘蛛）** - 岩や山の近くに出現
- **🐉 DRAGON（ドラゴン）** - 遺跡の守護者として固定出現。倒すと再出現しない

### 洞窟の敵
- **👻 GHOST（ゴースト）** - 洞窟に出現
- **🧛‍♂️ VAMPIRE（ヴァンパイア）** - 洞窟に出現
- **🧌 TROLL（トロール）** - 洞窟に出現

洞窟の敵はフィールドよりも強力です。装備を整えてから挑戦しましょう。

### 敵ステータステーブル

| 敵 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|---|---|---|---|---|---|---|
| SLIME | FIELD | 8-12 | 2-3 | 0 | 3-5 | 4-8 |
| BAT | FIELD | 14-18 | 3-4 | 0-1 | 6-8 | 8-12 |
| SPIDER | FIELD | 20-26 | 4-6 | 1-2 | 9-12 | 12-16 |
| GHOST | CAVE | 28-34 | 6-7 | 2-3 | 12-16 | 16-20 |
| VAMPIRE | CAVE | 36-44 | 7-9 | 3-4 | 18-24 | 22-28 |
| TROLL | CAVE | 48-58 | 9-11 | 4-5 | 24-32 | 28-36 |
| DRAGON | FIELD固定 | 60-80 | 9-11 | 4-5 | 30-40 | 35-50 |

※ステータスは出現時に範囲内でランダムに決定されます

## 戦闘システム

- 敵シンボルに接触するとターン制バトルが開始（プレイヤー先攻）
- **勝利時**：EXP獲得 + Gold獲得 + HP+3回復
- **敗北時**：安全地帯に戻り、HP全回復（Gold等は失わない）
- 逃走成功率は50%

### ダメージ計算

```
通常攻撃ダメージ = max(1, 攻撃者ATK + ランダム(0~2) - 防御者DEF)
防御時ダメージ = ceil(通常ダメージ / 2)
```

- **攻撃**：ATKとDEFの差に0~2のランダム値が加算され、最低1ダメージは保証
- **防御**：選択したターンのみ受けるダメージを50%軽減（切り上げ）。次ターンには効果が切れる
- **逃走**：50%の確率で成功。失敗すると敵の攻撃を受ける

## レベルアップシステム

経験値を獲得するとレベルアップします：
- **レベルアップ時の効果**：MaxHP+5、ATK+1、DEF+1、HP+5回復
- **必要経験値**：LV2=10 / LV3=30 / LV4=60 / LV5=100 / LV6=160

## ゲームの進め方

1. フィールドを探索し、敵を倒して経験値と金を獲得
2. 村（🏘️）に入り、商人から食料やポーション、装備を購入
3. 宿屋主人（🛏️）に話しかけて10Goldで休息し、HPを回復
4. 食料を管理しながら洞窟（入口🕳️ / 出口🪜）を探索
5. 洞窟の宝箱（📦）から **Ancient Key** を入手
6. 鍵を持って遺跡（🏛️）に到達するとクリア

### クリア条件

1. 洞窟内の宝箱（x:10, y:8）を開いて **Ancient Key** を入手
2. Ancient Keyを所持した状態でフィールドの遺跡（🏛️）に触接
3. ゲームクリア！

## 高度なゲームメカニクス

### 敵AIシステム

敵（ドラゴンを除く）は**A*アルゴリズム**を使用してプレイヤーを追跡します：

- **追跡範囲**: プレイヤーとの距離が6タイル以内の場合のみ移動
- **経路探索**: 障害物を避けながら最短経路でプレイヤーに接近
- **移動制限**: 敵同士の衝突を回避し、移動可能なタイルのみを通過

### 敵のリスポーンシステム

- **リスポーン判定**: プレイヤーが20歩移動するごとに敵数を調整
- **FIELD**: 常時3-5体を維持（ドラゴンは別カウント）
- **CAVE**: 常時2-4体を維持
- **スポーン条件**: プレイヤーから距離4以上離れた場所にのみ出現
- **ドラゴン**: 固定位置に出現し、倒すと再出現しない（`dragonDefeated`フラグ）

### 敵のスポーン位置選定

敵の出現場所は地形に基づいて決定されます：

- **木の近くまたは木上**: BAT または SPIDER（ランダム）
- **岩や山の近く**: SPIDER
- **その他の場所**: SLIME または BAT（ランダム）
- **洞窟**: GHOST、VAMPIRE、TROLL（ランダム）

スポーン試行は最大200回まで行い、以下の条件を満たす場所を探します：
- プレイヤーから距離4以上
- 占有セル（敵、NPC、宝箱など）との重複なし
- 移動可能なタイル（水、山、岩、壁を除く）

### マップ遷移とスポーン地点

各シーン間の移動時にスポーン地点が変化します：

| 遷移 | トリガー | スポーン地点 |
|---|---|---|
| FIELD → VILLAGE | 村入口触接 | VILLAGE南扉下 |
| VILLAGE → FIELD (南) | 南扉触接 | FIELD村入口下1タイル |
| VILLAGE → FIELD (北) | 北扉触接 | FIELD村入口上1タイル |
| FIELD → CAVE | 洞窟入口触接 | CAVE出口下1タイル |
| CAVE → FIELD | 洞窟出口触接 | FIELD洞窟入口下1タイル |

### メッセージシステム

画面左下のメッセージパネルには常に最新の3件のメッセージのみ表示されます：

- **表示位置**: 左下パネル（120px高さ）
- **表示件数**: 最大3行
- **内容**: 戦闘結果、レベルアップ、アイテム入手、Food消費警告など

## 技術スタック

- **フレームワーク**: p5.js 1.6.0
- **言語**: JavaScript ES6+
- **レンダリング**: Canvas 2D
- **アーキテクチャ**: モジュール設計（IIFE パターン）
- **アルゴリズム**: A*パス検索（敵AI）
- **ステート管理**: 集中型（game_state.js）
