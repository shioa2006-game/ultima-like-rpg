# Ultima-like RPG

ブラウザで動作する探索型RPG。Ultima シリーズにインスパイアされた、リソース管理とターン制戦闘を特徴とする2Dトップダウンアドベンチャーゲームです。

## 目次

- [ゲーム概要](#ゲーム概要)
- [プレイ方法](#プレイ方法)
- [プロジェクト構造](#プロジェクト構造)
- [操作方法](#操作方法)
- [ゲームシステム](#ゲームシステム)
- [技術スタック](#技術スタック)
- [開発情報](#開発情報)

## ゲーム概要

小さな島に漂着した冒険者（🧝）となって、生存を図りながら島の謎を解く探索型RPGです。
フィールドを探索し、敵と戦い、商人から物資を補給しながら、最終的に洞窟で **Ancient Key** を入手し、遺跡の門を開いて中枢に到達することが目標です。

**ゲーム仕様:**
- キャンバスサイズ: 800x600 (24x18グリッド、48pxタイル)
- シーン: 3つの相互接続されたマップ (FIELD, TOWN, CAVE)
- 言語: 日本語（すべてのUI/メッセージ）
- コード規模: 約3,620行のJavaScript（11モジュール）

### 世界

ゲームは3つのシーンで構成されています：

- **FIELD（フィールド）** - 島全体。探索、戦闘、各施設への入口がある
- **TOWN（街）** - 安全地帯。商人🧙‍♂️がいて、物資の売買ができる。宿屋🛏️で休息も可能
- **CAVE（洞窟）** - ミニ区画。宝箱に重要なアイテムがある。強力な敵が出現

## プレイ方法

以下のリンクからブラウザでアクセスするだけでプレイできます：

**🎮 ゲームリンク**: https://shioa2006-game.github.io/ultima-like-rpg/

### 必要要件
- モダンブラウザ（Chrome、Firefox、Safari、Edge等）

## プロジェクト構造

```
ultima-like-rpg/
├── index.html              # HTMLエントリポイント
├── style.css               # スタイルシート（42行）
├── sketch.js               # p5.js メインループ（56行）
├── game_state.js           # ゲーム状態管理（1,079行）
├── map_data.js             # マップ定義とシーン遷移（328行）
├── entities.js             # 敵/NPCシステムとAI（467行）
├── renderer.js             # キャンバスレンダリングとUI表示（546行）
├── dialogue.js             # NPC対話システム（223行）
├── input.js                # 入力処理とゲームコントロール（373行）
├── combat.js               # ターン制バトルシステム（147行）
├── shop.js                 # ショップ/商人インタラクション（173行）
├── inn.js                  # 宿屋システム（68行）
├── utils.js                # ユーティリティ関数（A*パスファインディング含む）（160行）
├── assets/
│   ├── tiles.png           # タイルセットスプライト（48x48/タイル）
│   ├── actors.png          # プレイヤー/NPC スプライト
│   ├── enemies.png         # 敵スプライト（7種類）
│   ├── objects_interactable.png  # 宝箱など インタラクティブオブジェクト
│   └── dialogues.json      # NPC対話データ
├── README.md               # このファイル
├── GAME_DESIGN.md          # 設計仕様書
├── Progress.md             # 開発進捗管理
├── Gap.md                  # 既知の課題
└── AGENTS.md               # 開発ガイドライン
```

### モジュール詳細

| ファイル | 行数 | 責務 |
|---------|------|------|
| `game_state.js` | 1,079 | プレイヤー統計、インベントリ、フラグ、占有マップ、アイテム取引の中央管理 |
| `renderer.js` | 546 | タイルマップ、エンティティ、UIパネル、オーバーレイ、バトル画面、クリア画面の描画 |
| `entities.js` | 467 | 敵のスポーン、AIパスファインディング、移動、レンダリング、ワールドとのインタラクション |
| `input.js` | 373 | 移動、戦闘アクション、UIナビゲーション、NPCインタラクションのキーボード処理 |
| `map_data.js` | 328 | 3シーンのタイル定義、スポーン地点、入口/出口設定 |
| `dialogue.js` | 223 | NPC対話システム：セリフデータ管理、会話セッション、段階的ストーリー進行 |
| `shop.js` | 173 | 商人とのやり取り：購入、売却、価格計算、インベントリチェック |
| `utils.js` | 160 | ユーティリティ関数：A*パスファインディング、距離計算、乱数生成 |
| `combat.js` | 147 | バトルメカニクス：ダメージ計算、ターンフロー、勝利/敗北処理 |
| `inn.js` | 68 | 宿屋主人とのやり取り：宿泊検証とHP回復 |
| `sketch.js` | 56 | p5.jsエントリポイント：アセット読み込み、キャンバス設定、メイン描画ループ |

### 初期プレイヤーステータス

```
HP: 30 | MaxHP: 30
ATK: 5 | DEF: 3
Level: 1 | EXP: 0
Food: 50 | Gold: 50
Inventory: 空（最大6スロット）
```

### リソース管理

生存のために以下のリソースを管理する必要があります：

- **HP（体力）** - 0になると安全地帯に戻され、HPが全回復する
- **Food（食料）** - フィールドや洞窟で2歩ごとに1消費（街では消費しない）。0になると歩くたびにHPが減少。**上限999**
- **Gold（所持金）** - 商人から物資を購入するために必要
- **装備** - 武器スロット1つと盾スロット1つ。装備中のアイテムは売却不可
  - **Bronze Sword**（ATK+2） - 武器スロット
  - **Wood Shield**（DEF+2） - 盾スロット
- **インベントリ** - 最大6個までアイテムを所持可能（Food10は累積型で容量外）

## 操作方法

### コントロール一覧

| アクション | キー |
|-----------|-----|
| **移動** | 矢印キー（↑↓←→） |
| **会話/インタラクト** | T |
| **インベントリを開く** | I |
| **ステータス表示** | S |
| **戦闘: 攻撃** | A |
| **戦闘: 防御** | D |
| **戦闘: 逃げる** | R |
| **ショップ: 購入** | B |
| **ショップ: 売却** | S |
| **ショップ: 選択** | ↑↓ |
| **インベントリ: 使用** | U |
| **インベントリ: 詳細** | Enter |
| **宿屋: はい** | Y |
| **宿屋: いいえ** | N |
| **決定** | Enter |
| **キャンセル/閉じる** | Esc |

## ゲームシステム

### ゲームの進め方

1. フィールドを探索し、敵を倒して経験値と金を獲得
2. 街（🏘️）に入り、商人から食料やポーション、装備を購入
3. 宿屋主人（🛏️）に話しかけて10Goldで休息し、HPを回復
4. 食料を管理しながら洞窟（入口🕳️ / 出口🪜）を探索
5. 洞窟の宝箱（📦）から **Ancient Key** を入手
6. 鍵を持って遺跡（🏛️）に到達するとクリア

**クリア条件:**
1. 洞窟内の宝箱（x:10, y:8）を開いて **Ancient Key** を入手
2. Ancient Keyを所持した状態でフィールドの遺跡（🏛️）に接触
3. ゲームクリア！

### 敵の種類と出現エリア

ゲームには7種類の敵が登場します：

### フィールドの敵
- **🫠 SLIME（スライム）** - 最も弱い敵。草原に出現
- **🦇 BAT（コウモリ）** - 木の近くに出現
- **🕷 SPIDER（蜘蛛）** - 岩や山の近くに出現
- **🐉 DRAGON（ドラゴン）** - 遺跡の守護者として固定出現。倒すと再出現しない

### 洞窟の敵
- **👻 GHOST（ゴースト）** - 洞窟に出現
- **🧛‍♂️ VAMPIRE（ヴァンパイア）** - 洞窟に出現
- **🧌 TROLL（トロール）** - 洞窟に出現

洞窟の敵はフィールドよりも強力です。装備を整えてから挑戦しましょう。

### 敵ステータステーブル

| 敵 | 出現場所 | HP | ATK | DEF | EXP | Gold |
|---|---|---|---|---|---|---|
| SLIME | FIELD | 8-12 | 2-3 | 0 | 3-5 | 4-8 |
| BAT | FIELD | 14-18 | 3-4 | 0-1 | 6-8 | 8-12 |
| SPIDER | FIELD | 20-26 | 4-6 | 1-2 | 9-12 | 12-16 |
| GHOST | CAVE | 28-34 | 6-7 | 2-3 | 12-16 | 16-20 |
| VAMPIRE | CAVE | 36-44 | 7-9 | 3-4 | 18-24 | 22-28 |
| TROLL | CAVE | 48-58 | 9-11 | 4-5 | 24-32 | 28-36 |
| DRAGON | FIELD固定 | 60-80 | 9-11 | 4-5 | 30-40 | 35-50 |

※ステータスは出現時に範囲内でランダムに決定されます

## 戦闘システム

- 敵シンボルに接触するとターン制バトルが開始（プレイヤー先攻）
- **勝利時**：EXP獲得 + Gold獲得 + HP+3回復
- **敗北時**：安全地帯に戻り、HP全回復（Gold等は失わない）
- 逃走成功率は50%

### ダメージ計算

```
通常攻撃ダメージ = max(1, 攻撃者ATK + ランダム(0~2) - 防御者DEF)
防御時ダメージ = ceil(通常ダメージ / 2)
```

- **攻撃**：ATKとDEFの差に0~2のランダム値が加算され、最低1ダメージは保証
- **防御**：選択したターンのみ受けるダメージを50%軽減（切り上げ）。次ターンには効果が切れる
- **逃走**：50%の確率で成功。失敗すると敵の攻撃を受ける

## レベルアップシステム

経験値を獲得するとレベルアップします：
- **レベルアップ時の効果**：MaxHP+5、ATK+1、DEF+1、HP+5回復
- **必要経験値**：LV2=10 / LV3=30 / LV4=60 / LV5=100 / LV6=150 / LV7=210 / LV8=280 / LV9=360 / LV10=440

## 高度なゲームメカニクス

### 敵AIシステム

敵（ドラゴンを除く）は**A*アルゴリズム**を使用してプレイヤーを追跡します：

- **追跡範囲**: プレイヤーとの距離が7タイル以内の場合のみ移動
- **経路探索**: 障害物を避けながら最短経路でプレイヤーに接近
- **移動制限**: 敵同士の衝突を回避し、移動可能なタイルのみを通過

### 敵のリスポーンシステム

- **リスポーン判定**: プレイヤーが20歩移動するごとに敵数を調整
- **FIELD**: 常時3-5体を維持（ドラゴンは別カウント）
- **CAVE**: 常時2-4体を維持
- **スポーン条件**: プレイヤーから距離4以上離れた場所にのみ出現
- **ドラゴン**: 固定位置に出現し、倒すと再出現しない（`dragonDefeated`フラグ）

### 敵のスポーン位置選定

敵の出現場所は地形に基づいて決定されます：

- **木の近くまたは木上**: BAT または SPIDER（ランダム）
- **岩や山の近く**: SPIDER
- **その他の場所**: SLIME または BAT（ランダム）
- **洞窟**: GHOST、VAMPIRE、TROLL（ランダム）

スポーン試行は最大200回まで行い、以下の条件を満たす場所を探します：
- プレイヤーから距離4以上
- 占有セル（敵、NPC、宝箱など）との重複なし
- 移動可能なタイル（水、山、岩、壁を除く）

### マップ遷移とスポーン地点

各シーン間の移動時にスポーン地点が変化します：

| 遷移 | トリガー | スポーン地点 |
|---|---|---|
| FIELD → TOWN | 街入口触接 | TOWN南扉下 |
| TOWN → FIELD (南) | 南扉触接 | FIELD街入口下1タイル |
| TOWN → FIELD (北) | 北扉触接 | FIELD街入口上1タイル |
| FIELD → CAVE | 洞窟入口触接 | CAVE出口下1タイル |
| CAVE → FIELD | 洞窟出口触接 | FIELD洞窟入口下1タイル |

### メッセージシステム

画面右下のメッセージパネルには常に最新の4件のメッセージのみ表示されます：

- **表示位置**: 左下パネル（150px高さ）
- **表示件数**: 最新4件（自動改行により最大6行程度）
- **内容**: 戦闘結果、レベルアップ、アイテム入手、Food消費警告、NPC会話など

#### NPC会話システム

NPCとの会話はTキーで段階的に進行します：

- **進行マーカー**: 続きがあるセリフには `[>]` が表示される
- **会話終了**: 最後のセリフには `[>]` がなく、空行で終了を示す
- **クールダウン**: 会話終了後、1回移動するまで同じ会話を再開できない

**セリフ作成ガイドライン:**
- 1件のセリフ: **40文字以内**を推奨（最大50文字）
- 1回の会話: **3-4件**のセリフを推奨（空行含めて最大6行程度に収める）
- 最後以外のセリフに `[>]` マーカーを付ける

## 技術スタック

### コア技術

- **言語**: JavaScript ES6+
- **フレームワーク**: p5.js 1.6.0（Canvas-based graphics library）
- **レンダリング**: HTML5 Canvas 2D
- **アーキテクチャパターン**: IIFE（Immediately Invoked Function Expression）モジュールパターン

### アルゴリズム

- **A*パスファインディング**: 敵の追跡AI（`utils.js`）
- **マンハッタン距離**: 衝突・近接判定
- **乱数生成**: 敵スポーン、戦闘ダメージ計算

### アーキテクチャ設計

- **モジュール設計**: 11個の独立したIIFEモジュールでグローバル名前空間の汚染を防止
- **中央集権型ステート管理**: 単一の`Game.state`オブジェクトで状態管理
- **イベント駆動**: タイルイベント解決（ワープ、宝箱、バトル）
- **対話システム**: JSON駆動のNPC会話とストーリー進行管理
- **占有グリッド**: 24x18グリッドで各タイルの占有状況を追跡
- **レイヤーベースレンダリング**: FLOOR → DECOR → STATIC → NPC → ENEMY → PLAYER

### ゲーム設定

```javascript
config = {
  canvasWidth: 800,
  canvasHeight: 600,
  tileSize: 48,
  gridWidth: 24,
  gridHeight: 18,
}
```

### タイルタイプ

15種類のタイルタイプ：
- **地形**: GRASS, WATER, MOUNTAIN, ROCK, TREE
- **建造物**: WALL, DOOR, FLOOR_BUILD, FLOOR_CAVE
- **イベント**: ENTRANCE_TOWN, ENTRANCE_CAVE, STAIRS_UP, RUINS

### アセット

```javascript
// sketch.js preload()で読み込み
- tiles.png (48x48 sprites, 8列のタイルセット)
- actors.png (プレイヤー、商人、宿屋主人)
- enemies.png (7種類の敵)
- objects_interactable.png (宝箱など)
- dialogues.json (NPC対話データ)
```

## 開発情報

### プロジェクトステータス

**開発段階**: MVP完成、コアゲームループ実装済み

**最近の改善** (Progress.mdより):
- 全モジュールのリファクタリングによるコード品質向上
- エンティティ/イベントインタラクションのバグ修正
- 日本語UI/メッセージの標準化
- 占有システムの信頼性向上のためのオーバーホール

**既知の課題**: なし（Gap.mdは空）

### 技術ハイライト

**強み:**
- IIFEパターンによるクリーンなモジュール設計
- A*パスファインディングによる知的な敵の挙動
- 遅延占有グリッド再構築によるフレームごとのオーバーヘッド削減
- 単一場所での包括的なステート管理
- 日本語ローカライゼーション（日本人プレイヤーにフレンドリー）

**注目すべき技術的特徴:**
- マンハッタン距離による高速近接チェック
- レイヤーベースレンダリング（視覚的クリッピング防止）
- メッセージ管理のためのイベントキュー
- スプライトシートベースアニメーション準備（将来の拡張基盤）
- パラメータ化可能な敵スポーン挙動

---

**楽しいゲームプレイを！** 🎮
