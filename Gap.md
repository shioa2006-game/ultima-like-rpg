# Gap Log

## タイル／画面レイアウト
- 設計: タイルサイズは 32px 固定で 800x360 のマップ領域を常時表示する前提。
- 実装: `game_state.js:11` で `tileSize` を 40px に拡大し、カメラスクロールで 800x360 の表示範囲に収める構成へ変更。
- 変更理由: タイルを大きくして視認性を高めつつ、広いフィールドを探索できるようにするため。

## 占有管理とイベント処理
- 設計: 通行判定と入口イベントのみを想定。
- 実装: `game_state.js:124` の `NO_ENEMY_RADIUS` と `game_state.js:301` の占有マーキング、`game_state.js:603` の `resolveTileEvent` を導入し、NPC/敵/宝箱/遺跡の重なりを禁止してイベント優先度を管理。
- 変更理由: NPC や宝箱と重なって移動不能になる事故を防ぎ、イベント処理順序を明示するため。

## 入力キーの運用
- 設計: `U` でアイテム使用、`Enter` 決定、`Esc` キャンセルを想定。
- 実装: `input.js:34` でフィールド上の `U` 入力をメッセージ通知に限定し、`input.js:89` 以降でインベントリ表示中のみ `U` による使用を許可。`Esc` はオーバーレイ閉鎖専用に整理。
- 変更理由: 誤操作を防ぎ、操作対象をオーバーレイにフォーカスさせるため。

## ショップ操作制御
- 設計: Buy/Sell の切り替えと価格表示のみを想定。
- 実装: `shop.js:40` で `B`/`S` キーによるモード切替と購入・売却を統合し、`shop.js:109` で装備中アイテムの売却を禁止するガードを追加。
- 変更理由: キー操作を明確化し、装備品の誤売却を防止するため。

## メッセージログ
- 設計: 3 行パネルの提示のみ記載。
- 実装: `game_state.js:430` の `pushMessage` で最新 3 件を保持し、それ以外は破棄する簡易ログを採用。
- 変更理由: 表示領域を固定しつつ読みやすさを維持するため。

## 敵シンボルと出現範囲
- 設計: フィールドと洞窟に敵が出現する想定のみ。
- 実装: `entities.js:31` にフィールド/洞窟の最小最大数、`entities.js:36` の `SAFE_DISTANCE_FROM_PLAYER`、`entities.js:180` のスポーン制限でプレイヤー周辺や遺跡への敵配置を制御。
- 変更理由: 開始直後に即戦闘になる事態を避けつつ、ドラゴンとの遭遇をコントロールするため。

## 進行イベントの扱い
- 設計: 洞窟の宝箱で鍵を入手し、遺跡で使用してクリアする想定。
- 実装: `game_state.js:252` で `progressFlags` を初期化し、`game_state.js:629` 以降で鍵取得とクリア判定をフラグ管理に変更。鍵タイルは通行可能として演出を `Game.EVENTS` に集約。
- 変更理由: インベントリ上限で鍵が拾えないケースを避け、進行を確実にするため。

## 敵AIの挙動
- 設計: 敵の移動仕様は未定義。
- 実装: `utils.js:45` に A* 探索を追加し、`entities.js:262` の `moveEnemiesTowardPlayer` でドラゴン以外の敵がマンハッタン距離 6 以内で追尾、それ以外では待機する挙動に変更。
- 変更理由: 処理負荷を抑えつつプレイヤー追跡の緊張感を演出するため。

## 村マップの出入口
- 設計: 村からフィールドへの出口は 1 箇所を想定。
- 実装: `map_data.js:87` と `map_data.js:104` に北側扉を追加し、`map_data.js:163` の `fromVillageNorth` などで南北それぞれのフィールド出現位置を分岐。扉直下のタイルは床 (`f`) に変更して視認性を向上。
- 変更理由: 村内動線を短縮し、扉位置を強調するため。

## 戦闘報酬と敵パラメータ
- 設計: 勝利時に EXP + Gold + ランダムで Food/Potion を配布し、敵能力値は設計表のレンジを使用。
- 実装: `combat.js:100` で勝利時に HP+3 を付与しつつ EXP/Gold のみを配布し、ランダムドロップは未実装。`game_state.js:140` 以降で敵ごとの HP/ATK/DEF/EXP/Gold レンジを再調整。
- 変更理由: アイテムが過剰にならないよう制御し、戦闘直後の立て直しを容易にするため。また初期バランス調整の都合で敵能力値を微調整した。
