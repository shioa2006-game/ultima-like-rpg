# Gap Log

## タイル / 画面レイアウト
- 設計: タイルサイズは 32px 固定で 800x360 のマップ領域を常時表示する前提。
- 実装: `Game.config.tileSize` を 40px に拡大し、カメラでスクロールして 800x360 を維持。
- 変更理由: タイルを大きくして視認性を上げつつ、スクロールで全体探索を可能にするため。

## 占有管理とイベント処理
- 設計: 通行判定と入口イベントのみが明記されている。
- 実装: `game_state.js` に占有テーブル・予約タイル・NO_ENEMY_RADIUS を導入し、NPC/敵/宝箱/遺跡を同一マスに重ならないよう制御。`resolveTileEvent` で敵→ワープ→その他（宝箱/遺跡）を優先度付きで処理。
- 変更理由: 商人や宝箱と重なって動けない事故を防ぎ、安全なイベント順序を確保するため。

## 入力キーの運用
- 設計: `U` でアイテム使用、`Enter` で決定、`Esc` でキャンセル程度の想定。
- 実装: `U` はインベントリオーバーレイ内のみ使用可能とし、フィールド上ではメッセージを表示。`Enter` はショップ選択・アイテム詳細・クリアリスタートに限定、`Esc` はオーバーレイ閉鎖専用。
- 変更理由: 誤操作を防止し、入力フォーカスをオーバーレイに集約するため。

## ショップ操作
- 設計: Buy/Sell のモード切替と価格表示のみ明記。
- 実装: `B` で購入、`S` で売却モード、`Enter` で確定。装備中アイテムは Sell 不可にし、メッセージで通知。
- 変更理由: キー操作を明確化し、装備品の誤売却を防ぐガードを追加するため。

## メッセージログ
- 設計: 3 パネル構成のみ提示。
- 実装: メッセージパネルは最新 3 件を表示し、古いログは流す簡易仕様。
- 変更理由: 表示領域を固定しつつ可読性を保つ妥協案。

## 敵シンボルの配置ルール
- 設計: FIELD に敵シンボル常駐、CAVE で出現、ドラゴンなどのエリート配置を想定。
- 実装: `entities.js` でフィールド 3〜5 体・洞窟 2〜4 体に加え、プレイヤーから SAFE_DISTANCE を確保・遺跡近辺にドラゴン固定スポーンを導入。占有テーブルに宝箱/遺跡を追加し、敵スポーンを禁止。
- 変更理由: 開幕即戦闘を避けつつ、ボスを遺跡付近で確実に遭遇させるための調整。

## 進行イベントの扱い
- 設計: 洞窟宝箱で鍵を入手し、遺跡で使用してクリア。
- 実装: 鍵はインベントリではなく `Game.flags.hasKey` で管理し、`Game.EVENTS` で宝箱座標と遺跡座標を定義。遺跡タイルは通行可能にし、鍵所持でクリア演出→Enter で `resetForNewGame()` を呼ぶ。
- 変更理由: インベントリ枠が埋まっても進行不能にならないようフラグ管理を採用し、クリア後の周回を簡単にするため。
